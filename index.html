<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Portfolio OS</title>
<style>
  /* Reset & base */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  html, body {
    margin:0; padding:0; height:100%;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: url('wallpaper.jpg') center center/cover no-repeat fixed;
    user-select: none;
    overflow: hidden;
    color: #222;
    transition: background-color 0.4s ease;
  }
  body.dark {
    background-color: #121212;
    color: #eee;
  }
  body.dark #top-bar,
  body.dark #dock,
  body.dark #notification-center,
  body.dark #context-menu,
  body.dark #spotlight-modal {
    background-color: rgba(28,28,30,0.8);
    color: #eee;
    backdrop-filter: blur(12px);
  }

  /* Top Bar */
  #top-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 36px;
    padding: 0 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: rgba(255,255,255,0.7);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(0,0,0,0.1);
    z-index: 10000;
    user-select: none;
  }
  body.dark #top-bar {
    background-color: rgba(20,20,20,0.85);
    border-color: rgba(255,255,255,0.1);
  }
  #top-bar .logo {
    font-weight: 700;
    font-size: 20px;
    color: #007aff;
    user-select: none;
    cursor: default;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
  }
  #clock {
    cursor: pointer;
    font-variant-numeric: tabular-nums;
    font-weight: 600;
    font-size: 14px;
    color: #444;
    transition: color 0.3s ease;
  }
  body.dark #clock {
    color: #ddd;
  }

  /* Dock */
  #dock {
    position: fixed;
    bottom: 14px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 16px;
    background-color: rgba(255,255,255,0.75);
    padding: 10px 18px;
    border-radius: 16px;
    backdrop-filter: blur(20px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    user-select: none;
    z-index: 9999;
    transition: background-color 0.4s ease;
  }
  body.dark #dock {
    background-color: rgba(20,20,20,0.85);
    box-shadow: 0 8px 18px rgba(0,0,0,0.6);
  }

  .dock-icon {
    width: 48px;
    height: 48px;
    cursor: pointer;
    user-select: none;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.22s cubic-bezier(0.3, 1, 0.3, 1), box-shadow 0.3s ease;
    color: #444;
  }
  body.dark .dock-icon {
    color: #ddd;
  }
  .dock-icon svg {
    width: 28px;
    height: 28px;
    stroke-width: 1.5;
    stroke: currentColor;
    fill: none;
  }
  .dock-icon:hover,
  .dock-icon:focus {
    outline: none;
    transform: scale(1.45);
    color: #007aff;
    box-shadow: 0 8px 14px rgba(0,122,255,0.6);
  }

  /* Desktop */
  #desktop {
    position: fixed;
    top: 36px;
    bottom: 70px;
    left: 0;
    right: 0;
    overflow: hidden;
    user-select: none;
    background: transparent;
  }

  .desktop-icon {
    position: absolute;
    width: 96px;
    height: 96px;
    padding: 8px 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 13px;
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
    text-align: center;
    color: #222;
    font-size: 13px;
  }
  body.dark .desktop-icon {
    color: #eee;
  }
  .desktop-icon:hover,
  .desktop-icon:focus {
    background-color: rgba(0,122,255,0.12);
    color: #007aff;
    outline: none;
  }
  .desktop-icon svg {
    width: 48px;
    height: 48px;
    margin-bottom: 6px;
    pointer-events: none;
  }

  /* Window */
  .window {
    position: absolute;
    width: 420px;
    height: 350px;
    background-color: rgba(255,255,255,0.98);
    border-radius: 18px;
    box-shadow: 0 12px 24px rgba(0,0,0,0.20);
    user-select: text;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: box-shadow 0.3s ease;
    z-index: 500;
  }
  body.dark .window {
    background-color: rgba(30,30,30,0.95);
    color: #eee;
    box-shadow: 0 14px 30px rgba(0,0,0,0.85);
  }
  .window.maximized {
    top: 36px !important;
    left: 0 !important;
    width: 100% !important;
    height: calc(100% - 106px) !important;
    border-radius: 0 !important;
  }

  /* Title Bar */
  .titlebar {
    height: 32px;
    display: flex;
    align-items: center;
    padding: 0 12px;
    -webkit-app-region: drag;
  }
  body.dark .titlebar {
    color: #aaa;
  }

  /* Traffic Lights */
  .traffic-lights {
    display: flex;
    gap: 11px;
    -webkit-app-region: no-drag;
  }
  .traffic-light {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: none;
    position: relative;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition:
      box-shadow 0.3s ease,
      filter 0.25s ease;
    color: transparent;
  }
  .traffic-light.close  { background-color: #ff5f57; }
  .traffic-light.minimize { background-color: #febc2e; }
  .traffic-light.maximize { background-color: #28c940; }
  .traffic-light:hover,
  .traffic-light:focus {
    outline: none;
    color: #282828;
    box-shadow: 0 0 3px 2px rgba(0,0,0,0.2);
  }
  .tl-symbol {
    position: absolute;
    top: 1px;
    font-size: 13px;
    font-weight: 700;
    user-select: none;
    pointer-events: none;
    opacity: 0;
    color: inherit;
    transition: opacity 0.17s ease;
  }
  .traffic-light:hover .tl-symbol,
  .traffic-light:focus .tl-symbol {
    opacity: 1;
  }

  /* Title */
  .title {
    flex-grow: 1;
    font-size: 14.8px;
    font-weight: 600;
    text-align: center;
    user-select: none;
    color: #444;
  }
  body.dark .title {
    color: #ddd;
  }

  /* Window Content */
  .window-content {
    flex-grow: 1;
    padding: 14px 16px 16px 16px;
    overflow-y: auto;
    font-size: 14.3px;
    color: #222;
  }
  body.dark .window-content {
    color: #eee;
  }

  /* Portfolio Project Cards */
  #portfolio-list {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }
  .project-card {
    flex: 1 1 45%;
    background-color: rgba(0,122,255,0.10);
    border-radius: 10px;
    padding: 10px 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background-color 0.25s ease;
  }
  .project-card:hover,
  .project-card:focus {
    background-color: rgba(0,122,255,0.25);
    color: #007aff;
    outline: none;
  }
  .project-icon {
    font-size: 22px;
    font-weight: 700;
    user-select: none;
    min-width: 40px;
    text-align: center;
  }
  .project-info {
    flex-grow: 1;
  }
  .project-info strong {
    font-weight: 600;
    font-size: 15px;
  }
  .project-info small {
    color: #555;
  }
  body.dark .project-card small {
    color: #bbb;
  }

  /* Browser */
  #browser-url {
    width: 100%;
    height: 32px;
    font-size: 14px;
    padding: 6px 10px;
    border: 1.5px solid #ccc;
    border-radius: 9px;
    outline-offset: 2px;
  }
  body.dark #browser-url {
    background-color: #333;
    border-color: #555;
    color: #eee;
  }
  #browser-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
  }
  #browser-go-btn {
    padding: 6px 14px;
    font-size: 14px;
    background-color: #007aff;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  #browser-go-btn:hover,
  #browser-go-btn:focus {
    background-color: #005bbf;
    outline: none;
  }
  #browser-frame {
    height: calc(100% - 50px);
    width: 100%;
    border: none;
    border-radius: 9px;
  }

  /* Calculator */
  #calculator-display {
    width: 100%;
    height: 50px;
    font-size: 24px;
    padding: 8px 14px;
    background-color: rgba(0,122,255,0.1);
    border-radius: 10px;
    text-align: right;
    margin-bottom: 14px;
    color: #007aff;
    font-weight: 600;
    user-select: text;
    overflow-wrap: break-word;
  }
  body.dark #calculator-display {
    background-color: #222;
    color: #66aaff;
  }
  #calculator-buttons {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
  }
  #calculator-buttons button {
    background-color: #007aff;
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 20px;
    padding: 14px 0;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }
  #calculator-buttons button.operator {
    background-color: #ff9500;
  }
  #calculator-buttons button:hover,
  #calculator-buttons button:focus {
    filter: brightness(1.15);
    outline: none;
  }

  /* Camera */
  #camera-video {
    width: 100%;
    border-radius: 12px;
  }
  #camera-capture {
    margin-top: 10px;
    border-radius: 12px;
    width: 100%;
  }
  #camera-capture.hidden {
    display: none;
  }
  #camera-capture.visible {
    display: block;
  }
  #camera-capture-canvas {
    border-radius: 12px;
    width: 100%;
  }
  #camera-capture-btn {
    margin-top: 8px;
    padding: 8px 14px;
    border: none;
    border-radius: 14px;
    background-color: #007aff;
    color: white;
    font-size: 16px;
    cursor: pointer;
    user-select: none;
  }
  #camera-capture-btn:hover,
  #camera-capture-btn:focus {
    background-color: #005bbf;
    outline: none;
  }

  /* Notes */
  #notes-list {
    max-height: 170px;
    overflow-y: auto;
    margin-bottom: 14px;
  }
  .note-item {
    background-color: rgba(0,122,255,0.12);
    padding: 10px 12px;
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .note-item:hover,
  .note-item:focus {
    background-color: rgba(0,122,255,0.3);
    color: #007aff;
    outline: none;
  }
  body.dark .note-item {
    background-color: rgba(255,255,255,0.06);
  }
  body.dark .note-item:hover,
  body.dark .note-item:focus {
    background-color: rgba(0,122,255,0.3);
  }
  #notes-editor {
    width: 100%;
    min-height: 90px;
    border-radius: 14px;
    border: 1.5px solid #ccc;
    padding: 10px 14px;
    font-size: 15px;
    resize: vertical;
    color: #222;
    font-family: inherit;
    outline-offset: 2px;
  }
  body.dark #notes-editor {
    background-color: #222;
    border-color: #444;
    color: #eee;
  }
  #notes-actions {
    margin-top: 10px;
    display: flex;
    gap: 14px;
    justify-content: flex-end;
  }
  #notes-actions button {
    padding: 8px 18px;
    background-color: #007aff;
    border: none;
    border-radius: 14px;
    color: white;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }
  #notes-actions button:hover,
  #notes-actions button:focus {
    background-color: #005bbf;
    outline: none;
  }

  /* Clock — World clocks */
  #world-clocks {
    margin-top: 14px;
    font-size: 14px;
  }
  #world-clocks div {
    margin-bottom: 6px;
  }
  #world-clocks span {
    font-weight: 600;
  }

  /* Settings */
  #settings-content label {
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
  }
  #settings-content select {
    width: 100%;
    padding: 8px 12px;
    font-size: 15px;
    border-radius: 13px;
    border: 1.5px solid #ccc;
    background: white;
    outline-offset: 2px;
    font-family: inherit;
    user-select: none;
  }
  body.dark #settings-content select {
    background-color: #222;
    border-color: #444;
    color: #eee;
  }
  #settings-content button {
    margin-top: 16px;
    padding: 10px 16px;
    font-size: 15px;
    font-weight: 700;
    background-color: #ff3b30;
    color: white;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }
  #settings-content button:hover,
  #settings-content button:focus {
    background-color: #c12a24;
    outline: none;
  }

  /* Notifications */
  #notification-center {
    position: fixed;
    bottom: 90px;
    right: 16px;
    width: 300px;
    max-height: 350px;
    background-color: rgba(255,255,255,0.95);
    backdrop-filter: blur(12px);
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    overflow: hidden;
    display: none;
    flex-direction: column;
    z-index: 100000;
  }
  body.dark #notification-center {
    background-color: rgba(28,28,30,0.95);
    color: #ddd;
  }
  #notification-center header {
    font-weight: 700;
    font-size: 16px;
    background: rgba(0,122,255,0.12);
    padding: 10px 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  body.dark #notification-center header {
    background-color: rgba(0,122,255,0.22);
  }
  #clear-all-notifications {
    background: none;
    border: none;
    font-weight: 700;
    color: #007aff;
    cursor: pointer;
    font-size: 14px;
    user-select:none;
    transition: color 0.25s ease;
  }
  #clear-all-notifications:hover,
  #clear-all-notifications:focus {
    color: #005bbf;
    outline: none;
  }
  #notifications-list {
    overflow-y: auto;
    max-height: 280px;
  }
  .notification {
    padding: 10px 18px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    font-size: 14px;
    color: #444;
  }
  body.dark .notification {
    border-bottom-color: rgba(255,255,255,0.1);
    color: #ddd;
  }
  .notification .dismiss-btn {
    float: right;
    font-weight: 700;
    color: #999;
    cursor: pointer;
    user-select: none;
  }
  .notification:hover .dismiss-btn,
  .notification .dismiss-btn:focus {
    color: #f44336;
    outline: none;
  }

  /* Spotlight Search Modal */
  #spotlight-modal {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    width: 360px;
    background-color: rgba(255,255,255,0.97);
    backdrop-filter: blur(15px);
    border-radius: 18px;
    box-shadow: 0 14px 32px rgba(0,0,0,0.24);
    padding: 16px;
    z-index: 20000;
    display: none;
    flex-direction: column;
  }
  body.dark #spotlight-modal {
    background-color: rgba(25,25,27,0.97);
    color: #eee;
  }
  #spotlight-input {
    width: 100%;
    padding: 12px 18px;
    font-size: 17px;
    border-radius: 14px;
    border: 1.7px solid #aaa;
    font-family: inherit;
    outline-offset: 2px;
    user-select:none;
  }
  body.dark #spotlight-input {
    background-color: #333;
    border-color: #555;
    color: #eee;
  }
  #spotlight-results {
    margin-top: 12px;
    max-height: 260px;
    overflow-y: auto;
  }
  .spotlight-result {
    padding: 8px 14px;
    border-radius: 11px;
    cursor: pointer;
    font-size: 15px;
    transition: background-color 0.25s ease;
  }
  .spotlight-result:hover,
  .spotlight-result:focus {
    background-color: rgba(0,122,255,.2);
    color: #007aff;
    outline: none;
  }
  body.dark .spotlight-result:hover,
  body.dark .spotlight-result:focus {
    background-color: rgba(0,122,255,0.3);
  }

  /* Context Menu */
  #context-menu {
    position: fixed;
    background-color: rgba(255,255,255,0.97);
    backdrop-filter: blur(16px);
    border-radius: 16px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    width: 200px;
    display: none;
    flex-direction: column;
    z-index: 30000;
    user-select:none;
  }
  body.dark #context-menu {
    background-color: rgba(30,30,32,0.97);
    color: #eee;
  }
  #context-menu button {
    background-color: transparent;
    border: none;
    padding: 14px 18px;
    font-size: 14.7px;
    cursor: pointer;
    text-align: left;
    border-radius: 12px;
    transition: background-color 0.18s ease, color 0.18s ease;
  }
  #context-menu button:hover,
  #context-menu button:focus {
    background-color: rgba(0,122,255,0.18);
    color: #007aff;
    outline: none;
  }

  /* Restart Animation Overlay */
  #restart-overlay {
    position: fixed;
    inset: 0;
    background-color: white;
    opacity: 0;
    pointer-events: none;
    transition: opacity 1.1s cubic-bezier(.4,1,.4,1);
    z-index: 40000;
  }
  body.dark #restart-overlay {
    background-color: #171719;
  }
  #restart-overlay.show {
    opacity: 1;
    pointer-events: auto;
  }

  /* Responsive */
  @media (max-width: 600px) {
    .window {
      width: 95vw !important;
      height: 70vh !important;
      top: 40px !important;
      left: 2.5vw !important;
      border-radius: 12px !important;
    }
    #dock {
      width: 90vw;
      left: 5vw;
      padding: 10px 15px;
    }
    .dock-icon {
      width: 38px !important;
      height: 38px !important;
    }
  }
</style>

</head>
<body>

<!-- Restart Overlay -->
<div id="restart-overlay"></div>

<!-- Top Bar -->
<div id="top-bar" role="banner">
  <div class="logo" aria-label="Portfolio OS Logo"></div>
  <div id="clock" aria-live="polite" role="timer" tabindex="0" title="Current time (click to toggle notifications)"></div>
</div>

<!-- Desktop -->
<div id="desktop" tabindex="0" aria-label="Desktop area: draggable icons and windows"></div>

<!-- Dock -->
<div id="dock" aria-label="Application Dock"></div>

<!-- Notification Center -->
<div id="notification-center" role="region" aria-live="polite" aria-label="Notification Center">
  <header>
    Notifications
    <button id="clear-all-notifications" aria-label="Clear All Notifications" title="Clear All Notifications">Clear All</button>
  </header>
  <div id="notifications-list"></div>
</div>

<!-- Spotlight Search Modal -->
<div id="spotlight-modal" role="dialog" aria-modal="true" aria-label="Spotlight Search">
  <input id="spotlight-input" type="search" placeholder="Search apps..." aria-label="Search Applications" autocomplete="off" />
  <div id="spotlight-results" role="list"></div>
</div>

<!-- Context Menu -->
<div id="context-menu" role="menu" tabindex="-1" aria-label="Desktop Context Menu">
  <button type="button" role="menuitem" data-action="restart">Restart</button>
  <button type="button" role="menuitem" data-action="toggle-theme">Toggle Theme</button>
  <button type="button" role="menuitem" data-action="new-note">New Note</button>
  <button type="button" role="menuitem" data-action="open-settings">System Preferences</button>
</div>
<script>
  (() => {
  "use strict";

  /* ----- ICONS: Inline SVG from Heroicons (Outline Style) ----- */
  // Replace path d attributes or entire SVG with actual Heroicons SVG paths
  // You can fetch these from https://heroicons.com/ for precise icons
  // This is a minimal subset for demo, replace ... by real paths.

  const HEROICONS = {
    portfolio: `
      <svg data-slot="icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <path d="M19.5 21a3 3 0 0 0 3-3v-4.5a3 3 0 0 0-3-3h-15a3 3 0 0 0-3 3V18a3 3 0 0 0 3 3h15ZM1.5 10.146V6a3 3 0 0 1 3-3h5.379a2.25 2.25 0 0 1 1.59.659l2.122 2.121c.14.141.331.22.53.22H19.5a3 3 0 0 1 3 3v1.146A4.483 4.483 0 0 0 19.5 9h-15a4.483 4.483 0 0 0-3 1.146Z"></path>
</svg>
    `,
    browser: `
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="m20.893 13.393-1.135-1.135a2.252 2.252 0 0 1-.421-.585l-1.08-2.16a.414.414 0 0 0-.663-.107.827.827 0 0 1-.812.21l-1.273-.363a.89.89 0 0 0-.738 1.595l.587.39c.59.395.674 1.23.172 1.732l-.2.2c-.212.212-.33.498-.33.796v.41c0 .409-.11.809-.32 1.158l-1.315 2.191a2.11 2.11 0 0 1-1.81 1.025 1.055 1.055 0 0 1-1.055-1.055v-1.172c0-.92-.56-1.747-1.414-2.089l-.655-.261a2.25 2.25 0 0 1-1.383-2.46l.007-.042a2.25 2.25 0 0 1 .29-.787l.09-.15a2.25 2.25 0 0 1 2.37-1.048l1.178.236a1.125 1.125 0 0 0 1.302-.795l.208-.73a1.125 1.125 0 0 0-.578-1.315l-.665-.332-.091.091a2.25 2.25 0 0 1-1.591.659h-.18c-.249 0-.487.1-.662.274a.931.931 0 0 1-1.458-1.137l1.411-2.353a2.25 2.25 0 0 0 .286-.76m11.928 9.869A9 9 0 0 0 8.965 3.525m11.928 9.868A9 9 0 1 1 8.965 3.525" />
</svg>

    `,
    github: `
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" >
        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12c0 4.418 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.008-.868-.013-1.703-2.782.603-3.369-1.343-3.369-1.343-.454-1.156-1.11-1.464-1.11-1.464-.907-.62.069-.608.069-.608 1.003.07 1.532 1.031 1.532 1.031.892 1.528 2.341 1.086 2.91.831.091-.647.349-1.086.633-1.337-2.22-.252-4.555-1.11-4.555-4.945 0-1.091.39-1.984 1.029-2.682-.103-.252-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.564 9.564 0 0112 6.844a9.6 9.6 0 012.503.337c1.91-1.294 2.748-1.025 2.748-1.025.546 1.376.202 2.395.1 2.647.64.698 1.028 1.591 1.028 2.682 0 3.842-2.337 4.69-4.564 4.937.359.309.678.915.678 1.846 0 1.333-.012 2.409-.012 2.737 0 .268.18.578.688.48A10.007 10.007 0 0022 12c0-5.52-4.48-10-10-10z"/>
      </svg>
    `,
    linkedin: `
      <svg xmlns="http://www.w3.org/2000/svg" fill="none"  viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M16 8a6 6 0 016 6v6h-4v-6a2 2 0 00-4 0v6h-4v-6a6 6 0 016-6zM2 9h4v12H2zM4 4a2 2 0 100 4 2 2 0 000-4z"/>
      </svg>
    `,
    calculator: `
      <svg data-slot="icon" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25V13.5Zm0 2.25h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25V18Zm2.498-6.75h.007v.008h-.007v-.008Zm0 2.25h.007v.008h-.007V13.5Zm0 2.25h.007v.008h-.007v-.008Zm0 2.25h.007v.008h-.007V18Zm2.504-6.75h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V13.5Zm0 2.25h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V18Zm2.498-6.75h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V13.5ZM8.25 6h7.5v2.25h-7.5V6ZM12 2.25c-1.892 0-3.758.11-5.593.322C5.307 2.7 4.5 3.65 4.5 4.757V19.5a2.25 2.25 0 0 0 2.25 2.25h10.5a2.25 2.25 0 0 0 2.25-2.25V4.757c0-1.108-.806-2.057-1.907-2.185A48.507 48.507 0 0 0 12 2.25Z"></path>
</svg>
    `,

    camera: `
      <svg data-slot="icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <path d="M12 9a3.75 3.75 0 1 0 0 7.5A3.75 3.75 0 0 0 12 9Z"></path>
  <path clip-rule="evenodd" fill-rule="evenodd" d="M9.344 3.071a49.52 49.52 0 0 1 5.312 0c.967.052 1.83.585 2.332 1.39l.821 1.317c.24.383.645.643 1.11.71.386.054.77.113 1.152.177 1.432.239 2.429 1.493 2.429 2.909V18a3 3 0 0 1-3 3h-15a3 3 0 0 1-3-3V9.574c0-1.416.997-2.67 2.429-2.909.382-.064.766-.123 1.151-.178a1.56 1.56 0 0 0 1.11-.71l.822-1.315a2.942 2.942 0 0 1 2.332-1.39ZM6.75 12.75a5.25 5.25 0 1 1 10.5 0 5.25 5.25 0 0 1-10.5 0Zm12-1.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z"></path>
</svg>
    `,
    notes: `
      <svg xmlns="http://www.w3.org/2000/svg" fill="none"  viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" d="M7 8h10M7 12h10M7 16h10"/>
        <rect x="4" y="4" width="16" height="16" rx="2" ry="2" stroke-width="1.8"/>
      </svg>
    `,
    settings: `
      <svg data-slot="icon" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"></path>
  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path>
</svg>
    `,

    close: `
      <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="2" y1="2" x2="8" y2="8"/>
        <line x1="8" y1="2" x2="2" y2="8"/>
      </svg>
    `,
    minimize: `
      <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <line x1="2" y1="5" x2="8" y2="5"/>
      </svg>
    `,
    maximize: `
      <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="2 8 5 5 8 8"/>
      </svg>
    `
  };

  /* ----- APP DEFINITIONS ----- */
  const apps = [
    {id: "portfolio", name: "Portfolio", icon: HEROICONS.portfolio, hasWindow: true},
    {id: "browser", name: "Browser", icon: HEROICONS.browser, hasWindow: true},
    {id: "github", name: "GitHub", icon: HEROICONS.github, url: "https://github.com/Sanket-Bharadwaj"},
    {id: "linkedin", name: "LinkedIn", icon: HEROICONS.linkedin, url:"https://www.linkedin.com/in/sanket-bharadwaj/"},
    {id: "calculator", name: "Calculator", icon: HEROICONS.calculator, hasWindow: true},
    {id: "camera", name:"Camera", icon: HEROICONS.camera, hasWindow:true},
    {id: "notes", name:"Notes", icon: HEROICONS.notes, hasWindow:true},
    {id: "settings", name:"Settings", icon: HEROICONS.settings, hasWindow:true},
    {id:"about", name:"About Me", icon:`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="12" cy="7" r="4" stroke-width="1.8"/><path stroke-width="1.8" d="M5.5 21a9 9 0 0 1 13 0"/></svg>`, hasWindow:true}
  ];

  /* ----- STORAGE KEYS ----- */
  const desktopPositionsKey = "portfolioOS_desktopIconPositions";
  const userPrefsKey = "portfolioOS_userPrefs";
  const notesKey = "portfolioOS_notes";

  /* ----- STATE ----- */
  let openWindows = new Map();
  let windowZIndex = 100;
  let currentTheme = "light"; // or dark
  let desktopIconPositions = {};
  let notes = [];

  /* ----- ROOT ELEMENTS ----- */
  const desktop = document.getElementById("desktop");
  const dock = document.getElementById("dock");
  const topClock = document.getElementById("clock");
  const notificationCenter = document.getElementById("notification-center");
  const notificationsList = document.getElementById("notifications-list");
  const clearAllNotificationsBtn = document.getElementById("clear-all-notifications");
  const spotlightModal = document.getElementById("spotlight-modal");
  const spotlightInput = document.getElementById("spotlight-input");
  const spotlightResults = document.getElementById("spotlight-results");
  const contextMenu = document.getElementById("context-menu");
  const restartOverlay = document.getElementById("restart-overlay");

  /* ----- UTILS ----- */
  const createEl = (tag, props = {}, children = []) => {
    const el = document.createElement(tag);
    for (const [k,v] of Object.entries(props)) {
      if(k === "className") el.className = v;
      else if (k.startsWith("data-")) el.setAttribute(k,v);
      else if (k === "textContent") el.textContent = v;
      else if (k === "innerHTML") el.innerHTML = v;
      else if (k.startsWith("aria")) el.setAttribute(k.replace(/([A-Z])/g, m => "-" + m.toLowerCase()), v);
      else if (k === "style") Object.assign(el.style, v);
      else el[k] = v;
    }
    children.forEach(c=> el.appendChild(c));
    return el;
  };
  const delay = ms => new Promise(r => setTimeout(r, ms));
  function genId() {
    return Math.random().toString(36).slice(2,10);
  }

  /* ----- Load/Save User Preferences ----- */
  function loadUserPrefs() {
    try {
      const prefs = JSON.parse(localStorage.getItem(userPrefsKey));
      if(prefs?.theme) currentTheme = prefs.theme;
      else currentTheme = "light";
      if(currentTheme === "dark") document.body.classList.add("dark");
      else document.body.classList.remove("dark");
      if(prefs?.wallpaperUrl) {
        document.body.style.backgroundImage = `url('${prefs.wallpaperUrl}')`;
      }
    } catch {
      currentTheme = "light";
    }
  }
  function saveUserPrefs() {
    localStorage.setItem(userPrefsKey, JSON.stringify({
      theme: currentTheme,
      wallpaperUrl: document.body.style.backgroundImage.replace(/^url\(["']?/, '').replace(/["']?\)$/, '')
    }));
  }

  /* ----- Desktop Icon Positions ----- */
  function loadDesktopIconPositions() {
    try {
      const raw = localStorage.getItem(desktopPositionsKey);
      if(raw) desktopIconPositions = JSON.parse(raw);
      else desktopIconPositions = {};
    } catch {
      desktopIconPositions = {};
    }
  }
  function saveDesktopIconPositions() {
    localStorage.setItem(desktopPositionsKey, JSON.stringify(desktopIconPositions));
  }

  /* ----- Notes Storage ----- */
  function loadNotes() {
    try {
      const raw = localStorage.getItem(notesKey);
      if(raw) notes = JSON.parse(raw);
      else notes = [];
    } catch {
      notes = [];
    }
  }
  function saveNotes() {
    localStorage.setItem(notesKey, JSON.stringify(notes));
  }

  /* ----- Notifications ----- */
  let notifications = [];
  function addNotification(msg, timeout=6000) {
    const id = genId();
    const notif = createEl("div", {className:"notification", textContent: msg});
    const dismissBtn = createEl("span", {className:"dismiss-btn", textContent:"×", tabindex:0, role:"button", title:"Dismiss notification"});
    notif.appendChild(dismissBtn);
    dismissBtn.addEventListener("click", e => {
      e.stopPropagation();
      notificationsList.removeChild(notif);
      notifications = notifications.filter(n => n.id !== id);
      if(notifications.length===0) hideNotifications();
    });
    notif.addEventListener("click", () => {
      dismissBtn.click();
    });
    notif.id = id;
    notificationsList.appendChild(notif);
    notifications.push({id, el: notif});

    if(notificationCenter.style.display !== "flex") showNotifications();

    if(timeout > 0) setTimeout(() => {
      if(notificationsList.contains(notif)) {
        notif.remove();
        notifications = notifications.filter(n => n.id !== id);
        if(notifications.length===0) hideNotifications();
      }
    }, timeout);
  }
  function showNotifications() {
    notificationCenter.style.display = "flex";
  }
  function hideNotifications() {
    notificationCenter.style.display = "none";
  }

  clearAllNotificationsBtn.addEventListener("click", () => {
    notificationsList.innerHTML = "";
    notifications = [];
    hideNotifications();
  });

  function toggleNotifications() {
    if(notificationCenter.style.display === "flex") hideNotifications();
    else showNotifications();
  }

  /* ----- Clock ----- */
  function updateClock() {
    const now = new Date();
    topClock.textContent = now.toLocaleTimeString();
  }
  topClock.addEventListener("click", () => toggleNotifications());
  setInterval(updateClock, 1000);
  updateClock();

  /* ----- Create Dock Icons ----- */
  function createDockIcon(app) {
    const btn = createEl("button", {
      className: "dock-icon",
      innerHTML: app.icon,
      title: app.name,
      "aria-label": app.name,
      tabIndex: 0,
      role: "button"
    });
    btn.addEventListener("click", e => {
      e.stopPropagation();
      if(app.hasWindow) toggleAppWindow(app.id);
      else if(app.url) openExternalUrl(app.url);
    });
    btn.addEventListener("keydown", e => {
      if(e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        btn.click();
      }
    });
    return btn;
  }
  function setupDock() {
    dock.innerHTML = "";
    apps.forEach(app => {
      dock.appendChild(createDockIcon(app));
    });
  }

  /* ----- Create Desktop Icons ----- */
  function createDesktopIcon(appId, appName, left, top) {
    const icon = apps.find(a => a.id === appId)?.icon || "";
    const el = createEl("div", {
      className: "desktop-icon",
      innerHTML: `${icon}<span>${appName}</span>`,
      tabIndex: 0,
      role: "button",
      "aria-label": appName,
      style: {left: left + "px", top: top + "px"}
    });
    // Drag Support (mouse + touch)
    let dragging = false, startX, startY, origLeft, origTop;

    function onDragStart(e) {
      if (e.target.closest(".traffic-light")) return;
      e.preventDefault();
      dragging = true;
      startX = e.type === "touchstart" ? e.touches[0].clientX : e.clientX;
      startY = e.type === "touchstart" ? e.touches[0].clientY : e.clientY;
      origLeft = parseFloat(el.style.left);
      origTop = parseFloat(el.style.top);
      document.addEventListener(e.type === "touchstart" ? "touchmove" : "mousemove", onDragMove, {passive:false});
      document.addEventListener(e.type === "touchstart" ? "touchend" : "mouseup", onDragEnd);
    }
    function onDragMove(e) {
      if(!dragging) return;
      const clientX = e.type === "touchmove" ? e.touches[0].clientX : e.clientX;
      const clientY = e.type === "touchmove" ? e.touches[0].clientY : e.clientY;
      let newLeft = origLeft + (clientX - startX);
      let newTop = origTop + (clientY - startY);
      // constrain within desktop
      newLeft = Math.min(Math.max(newLeft, 0), desktop.clientWidth - el.offsetWidth);
      newTop = Math.min(Math.max(newTop, 0), desktop.clientHeight - el.offsetHeight);
      el.style.left = newLeft + "px";
      el.style.top = newTop + "px";
    }
    function onDragEnd() {
      if(!dragging) return;
      dragging = false;
      desktopIconPositions[appId] = {left: parseFloat(el.style.left), top: parseFloat(el.style.top)};
      saveDesktopIconPositions();
      document.removeEventListener("mousemove", onDragMove);
      document.removeEventListener("mouseup", onDragEnd);
      document.removeEventListener("touchmove", onDragMove);
      document.removeEventListener("touchend", onDragEnd);
    }

    el.addEventListener("mousedown", onDragStart);
    el.addEventListener("touchstart", onDragStart, {passive:false});
    el.addEventListener("dblclick", () => openAppWindow(appId));
    el.addEventListener("keydown", e => {
      if(e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        openAppWindow(appId);
      }
    });

    return el;
  }

  function setupDesktopIcons() {
    desktop.innerHTML = "";
    // We'll use only three desktop icons for Portfolio, About Me and Notes for demo
    const desktopApps = [
      {id:"portfolio", name:"Portfolio"},
      {id:"about", name:"About Me"},
      {id:"notes", name:"Notes"}
    ];
    desktopApps.forEach((app,i) => {
      const pos = desktopIconPositions[app.id] || {left:40, top:40 + i*110};
      const el = createDesktopIcon(app.id, app.name, pos.left, pos.top);
      desktop.appendChild(el);
    });
  }

  /* ----- Window Management ----- */
  function bringWindowToFront(win) {
    windowZIndex++;
    win.style.zIndex = windowZIndex;
  }

  function createTrafficLight(type) {
    const btn = createEl("button", {className: "traffic-light " + type, role: "button", tabindex: 0});
    btn.setAttribute("aria-label", type.charAt(0).toUpperCase() + type.slice(1));
    btn.innerHTML = `<span class="tl-symbol">${
      type === "close" ? "×" : type === "minimize" ? "–" : "+"
    }</span>`;
    return btn;
  }

  function openExternalUrl(url) {
    window.open(url, "_blank", "noopener");
    addNotification(`Opened ${url} in a new tab.`);
  }

  function openAppWindow(appId) {
    let app = apps.find(a => a.id === appId);
    if(!app) return;

    if(!app.hasWindow) {
      if(app.url) {
        openExternalUrl(app.url);
      }
      return;
    }
    if(openWindows.has(appId)) {
      let win = openWindows.get(appId);
      if(win.classList.contains("minimized")) restoreWindow(win);
      bringWindowToFront(win);
      return;
    }

    const win = createEl("div", {className:"window", role:"dialog", tabIndex:0, "aria-label": `${app.name} window`});
    bringWindowToFront(win);

    // Titlebar & Traffic lights
    const titlebar = createEl("div", {className:"titlebar"});
    const trafficLights = createEl("div", {className:"traffic-lights"});
    const closeBtn = createTrafficLight("close");
    const minimizeBtn = createTrafficLight("minimize");
    const maximizeBtn = createTrafficLight("maximize");
    trafficLights.append(closeBtn, minimizeBtn, maximizeBtn);
    const titleElem = createEl("div", {className:"title", textContent: app.name});
    titlebar.append(trafficLights, titleElem);
    win.appendChild(titlebar);

    // Content area
    const content = createEl("div", {className: "window-content"});
    win.appendChild(content);

    // Insert app content
    switch(appId) {
      case "portfolio": fillPortfolio(content); break;
      case "browser": fillBrowser(content); break;
      case "calculator": fillCalculator(content); break;
      case "camera": fillCamera(content); break;
      case "notes": fillNotes(content); break;
      case "settings": fillSettings(content); break;
      case "about": fillAboutMe(content); break;
      default: 
        content.textContent = "App coming soon!";
    }

    desktop.appendChild(win);
    openWindows.set(appId, win);

    // Window drag support
    makeWindowDraggable(win, titlebar);

    // Traffic light events
    closeBtn.addEventListener("click", () => closeAppWindow(appId));
    minimizeBtn.addEventListener("click", () => minimizeWindow(win));
    maximizeBtn.addEventListener("click", () => toggleMaximizeWindow(win));

    win.addEventListener("mousedown", () => bringWindowToFront(win));
    win.addEventListener("keydown", e => {
      if(e.key === "Escape") closeAppWindow(appId);
    });

    addNotification(`${app.name} opened.`);
  }
  function closeAppWindow(appId) {
    const win = openWindows.get(appId);
    if(!win) return;
    win.style.transition = "opacity 0.25s ease";
    win.style.opacity = 0;
    setTimeout(() => {
      if(win.parentNode) win.parentNode.removeChild(win);
      openWindows.delete(appId);
    }, 300);
    addNotification(`${apps.find(a => a.id === appId)?.name} closed.`);
  }
  function minimizeWindow(win) {
    if(win.classList.contains("minimized")) return;
    win.classList.add("minimized");
    win.style.display = "none";
    addNotification(`Window minimized.`);
  }
  function restoreWindow(win) {
    if(!win.classList.contains("minimized")) return;
    win.style.display = "flex";
    win.classList.remove("minimized");
    addNotification(`Window restored.`);
  }
  function toggleMaximizeWindow(win) {
    if(win.classList.contains("maximized")) {
      win.classList.remove("maximized");
      addNotification("Window restored.");
    } else {
      win.classList.add("maximized");
      bringWindowToFront(win);
      addNotification("Window maximized.");
    }
  }
  function toggleAppWindow(appId) {
    if(openWindows.has(appId)) {
      const win = openWindows.get(appId);
      if(win.classList.contains("minimized")) restoreWindow(win);
      else minimizeWindow(win);
      bringWindowToFront(win);
    } else openAppWindow(appId);
  }

  // Drag windows by titlebar
  function makeWindowDraggable(win, dragHandle) {
    let dragging = false;
    let startX, startY, origLeft, origTop;

    function onPointerDown(e) {
      if(e.target.closest(".traffic-light")) return;
      dragging = true;
      bringWindowToFront(win);
      const rect = win.getBoundingClientRect();
      startX = e.clientX;
      startY = e.clientY;
      origLeft = rect.left;
      origTop = rect.top;
      document.addEventListener("pointermove", onPointerMove);
      document.addEventListener("pointerup", onPointerUp);
    }
    function onPointerMove(e) {
      if(!dragging) return;
      let newLeft = origLeft + e.clientX - startX;
      let newTop = origTop + e.clientY - startY;
      // Constrain within viewport desktop area
      newLeft = Math.min(Math.max(newLeft, 0), window.innerWidth - win.offsetWidth);
      newTop = Math.min(Math.max(newTop, 36), window.innerHeight - win.offsetHeight - 70);
      win.style.left = newLeft + "px";
      win.style.top = newTop + "px";
    }
    function onPointerUp() {
      dragging = false;
      document.removeEventListener("pointermove", onPointerMove);
      document.removeEventListener("pointerup", onPointerUp);
    }
    dragHandle.addEventListener("pointerdown", onPointerDown);
  }

  /* ----- APP CONTENTS ----- */

  // Portfolio app content
  const projects = [
    {name: "Project One", description: "Amazing JavaScript project", url: "https://github.com/Sanket-Bharadwaj/project-one", icon: "📁"},
    {name: "Project Two", description: "React awesome UI App", url: "https://github.com/Sanket-Bharadwaj/project-two", icon: "⚛️"},
    {name: "Project Three", description: "Node.js backend API", url: "https://github.com/Sanket-Bharadwaj/project-three", icon: "🛠️"}
  ];
  function fillPortfolio(container) {
    const list = createEl("div", {id:"portfolio-list"});
    projects.forEach(p => {
      const card = createEl("div", {className:"project-card", tabindex:0, role:"button", title: p.description, "aria-label": `Open project ${p.name}`});
      const iconDiv = createEl("div", {className:"project-icon", textContent: p.icon});
      const textDiv = createEl("div", {className:"project-info", innerHTML: `<strong>${p.name}</strong><br/><small>${p.description}</small>`});
      card.append(iconDiv,textDiv);
      card.addEventListener("click", () => openExternalUrl(p.url));
      card.addEventListener("keydown", e => {
        if(e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openExternalUrl(p.url);
        }
      });
      list.appendChild(card);
    });
    container.appendChild(list);
    const links = createEl("div", {style:{marginTop:"15px", fontWeight:"600"}});
    links.innerHTML = `Find me on:
      <a href="https://github.com/Sanket-Bharadwaj" target="_blank" rel="noopener" style="color:#007aff; user-select:none;margin-right:14px;">GitHub</a>
      <a href="https://www.linkedin.com/in/sanket-bharadwaj/"target="_blank" rel="noopener" style="color:#007aff;user-select:none;">LinkedIn</a>`;
    container.appendChild(links);
  }

  // Browser app content
  function fillBrowser(container) {
    container.innerHTML = "";
    const controls = createEl("div", {id:"browser-controls"});
    const urlInput = createEl("input", {id:"browser-url", type: "url", placeholder:"Enter URL and press Go"});
    urlInput.setAttribute("aria-label", "Browser URL input");
    const goBtn = createEl("button", {id:"browser-go-btn", textContent:"Go"});
    controls.append(urlInput, goBtn);
    const iframe = createEl("iframe", {id:"browser-frame", src:"about:blank", sandbox:"allow-same-origin allow-scripts allow-forms allow-popups"});
    container.append(controls, iframe);

    goBtn.addEventListener("click", () => {
      let url = urlInput.value.trim();
      if(!url) return;
      if(!url.match(/^https?:\/\//i)) url = "https://" + url;
      iframe.src = url;
      addNotification(`Browser loading: ${url}`);
    });
    urlInput.addEventListener("keydown", e => {
      if(e.key === "Enter") {
        e.preventDefault();
        goBtn.click();
      }
    });
  }

  // Calculator app content
  function fillCalculator(container) {
    container.innerHTML = "";
    let expression = "";

    const display = createEl("div", {id:"calculator-display", role:"textbox", "aria-live":"polite", textContent:"0"});
    container.appendChild(display);

    const btnValues = [ "7", "8", "9", "/",
                        "4", "5", "6", "*",
                        "1", "2", "3", "-",
                        "0", ".", "C", "+",
                        "=" ];
    const buttonsDiv = createEl("div", {id:"calculator-buttons"});
    btnValues.forEach(val => {
      const btn = createEl("button", {type:"button", textContent: val});
      if(["/", "*", "-", "+", "="].includes(val)) btn.classList.add("operator");
      btn.addEventListener("click", () => {
        if(val === "C") {
          expression = "";
          display.textContent = "0";
          return;
        }
        if(val === "=") {
          try {
            // A safer evaluation by allowing only numbers and operators
            const cleanExpr = expression.replace(/[^-()\d/*+.]/g, "");
            // eslint-disable-next-line no-eval
            const result = eval(cleanExpr);
            expression = result.toString();
          } catch {
            expression = "Error";
          }
          display.textContent = expression;
          return;
        }
        if(expression === "Error") expression = "";
        expression += val;
        display.textContent = expression;
      });
      buttonsDiv.appendChild(btn);
    });
    container.appendChild(buttonsDiv);
  }

  // Camera app content
  function fillCamera(container) {
    container.innerHTML = "";
    const video = createEl("video", {id:"camera-video", autoplay:true, playsInline:true});
    const captureBtn = createEl("button", {id:"camera-capture-btn", textContent:"Capture Photo"});
    const canvas = createEl("canvas", {id:"camera-capture-canvas"});
    canvas.style.display = "none";
    container.append(video, captureBtn, canvas);

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({video:true});
        video.srcObject = stream;
      } catch {
        container.textContent = "Unable to access camera.";
        addNotification("Camera access denied.");
      }
    }
    startCamera();

    captureBtn.addEventListener("click", ()=>{
      if(video.readyState < 2) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video,0,0);
      canvas.style.display = "block";
      addNotification("Photo captured.");
    });
  }

  // Notes app content
  function fillNotes(container) {
    loadNotes();
    container.innerHTML = "";
    const notesList = createEl("div", {id: "notes-list", "aria-live": "polite", tabIndex: 0, role:"list"});
    const textarea = createEl("textarea", {id:"notes-editor", placeholder:"Write your note here..."});
    const actions = createEl("div", {id:"notes-actions"});
    const saveBtn = createEl("button", {type:"button", textContent:"Save Note"});
    const deleteBtn = createEl("button", {type:"button", textContent:"Delete Note"});

    actions.append(saveBtn, deleteBtn);
    container.append(notesList, textarea, actions);

    let currentNoteId = null;

    function refreshNotesList() {
      notesList.innerHTML = "";
      notes.forEach(n => {
        const noteItem = createEl("div", {
          className: "note-item",
          textContent: n.content.slice(0,30) + (n.content.length > 30 ? "..." : ""),
          tabIndex: 0,
          role: "listitem",
          "data-id": n.id
        });
        noteItem.addEventListener("click", () => {
          currentNoteId = n.id;
          textarea.value = n.content;
        });
        noteItem.addEventListener("keydown", e => {
          if(e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            currentNoteId = n.id;
            textarea.value = n.content;
          }
        });
        notesList.appendChild(noteItem);
      });
    }
    function saveNote() {
      const val = textarea.value.trim();
      if(!val) {
        addNotification("Cannot save empty note.");
        return;
      }
      if(currentNoteId) {
        const idx = notes.findIndex(n => n.id === currentNoteId);
        if(idx >= 0) notes[idx].content = val;
      } else {
        notes.push({id: genId(), content: val});
      }
      currentNoteId = null;
      textarea.value = "";
      saveNotes();
      refreshNotesList();
      addNotification("Note saved.");
    }
    function deleteNote() {
      if(!currentNoteId) {
        addNotification("Select a note to delete.");
        return;
      }
      notes = notes.filter(n => n.id !== currentNoteId);
      currentNoteId = null;
      textarea.value = "";
      saveNotes();
      refreshNotesList();
      addNotification("Note deleted.");
    }

    saveBtn.addEventListener("click", saveNote);
    deleteBtn.addEventListener("click", deleteNote);

    refreshNotesList();
  }

  // Settings app content
  function fillSettings(container) {
    container.innerHTML = "";
    const contentDiv = createEl("div", {id:"settings-content"});

    // Theme selector
    const themeLabel = createEl("label", {textContent:"Theme:"});
    const themeSelect = createEl("select");
    ["light","dark"].forEach(t => {
      const opt = createEl("option", {value:t, textContent: t.charAt(0).toUpperCase() + t.slice(1)});
      if(t === currentTheme) opt.selected = true;
      themeSelect.appendChild(opt);
    });
    themeLabel.appendChild(themeSelect);

    // Wallpaper selector
    const wallpaperLabel = createEl("label", {textContent:"Wallpaper:"});
    const wallpaperSelect = createEl("select");
    const wallpapers = [
      {name:"Default", val:"wallpaper.jpg"},
      {name:"Mountains", val:"https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1280&q=80"},
      {name:"Beach", val:"https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1280&q=80"},
      {name:"Forest", val:"https://images.unsplash.com/photo-1468071174046-657d9d351a40?auto=format&fit=crop&w=1280&q=80"},
      {name:"None", val:""}
    ];
    wallpapers.forEach(wp => {
      const opt = createEl("option", {value: wp.val, textContent: wp.name});
      if(document.body.style.backgroundImage.includes(wp.val)) opt.selected = true;
      wallpaperSelect.appendChild(opt);
    });
    wallpaperLabel.appendChild(wallpaperSelect);

    // Reset Preferences Button
    const resetBtn = createEl("button", {type:"button", textContent:"Reset Preferences"});

    contentDiv.append(themeLabel, wallpaperLabel, resetBtn);
    container.appendChild(contentDiv);

    themeSelect.addEventListener("change", () => {
      currentTheme = themeSelect.value;
      if(currentTheme === "dark") document.body.classList.add("dark");
      else document.body.classList.remove("dark");
      saveUserPrefs();
      addNotification(`Theme changed to ${currentTheme}.`);
    });
    wallpaperSelect.addEventListener("change", () => {
      const val = wallpaperSelect.value;
      if(val) document.body.style.backgroundImage = `url('${val}')`;
      else document.body.style.backgroundImage = "";
      saveUserPrefs();
      addNotification("Wallpaper changed.");
    });
    resetBtn.addEventListener("click", () => {
      localStorage.removeItem(userPrefsKey);
      localStorage.removeItem(desktopPositionsKey);
      localStorage.removeItem(notesKey);
      location.reload();
    });
  }

  // About Me content
  function fillAboutMe(container) {
    container.innerHTML = `
      <h2>About Me</h2>
      <p>Hello! I'm a developer building this macOS-inspired portfolio OS.</p>
      <p>Explore my projects, skills, and professional profiles via this interactive desktop environment.</p>
      <p>This portfolio showcases modern web technologies: HTML, CSS, JavaScript with smooth UX and persistent settings.</p>
    `;
  }

  /* ----- Spotlight Search ----- */
  function openSpotlight() {
    spotlightModal.style.display = "flex";
    spotlightInput.value = "";
    spotlightInput.focus();
    updateSpotlightResults("");
  }
  function closeSpotlight() {
    spotlightModal.style.display = "none";
  }
  spotlightInput.addEventListener("input", e => {
    updateSpotlightResults(e.target.value);
  });
  function updateSpotlightResults(query) {
    query = query.toLowerCase();
    spotlightResults.innerHTML = "";
    const filtered = apps.filter(app => app.name.toLowerCase().includes(query) || app.id.includes(query));
    filtered.forEach(app => {
      const item = createEl("div", {className:"spotlight-result", textContent: app.name, tabIndex: 0, role:"listitem"});
      item.addEventListener("click", () => { openAppWindow(app.id); closeSpotlight(); });
      item.addEventListener("keydown", e => {
        if(e.key==="Enter" || e.key===" ") { e.preventDefault(); openAppWindow(app.id); closeSpotlight(); }
      });
      spotlightResults.appendChild(item);
    });
  }

  /* ----- Context Menu ----- */
  desktop.addEventListener("contextmenu", e => {
    e.preventDefault();
    showContextMenu(e.clientX, e.clientY);
  });
  function showContextMenu(x, y) {
    const cw = contextMenu.offsetWidth;
    const ch = contextMenu.offsetHeight;
    if(x + cw > window.innerWidth) x = window.innerWidth - cw - 8;
    if(y + ch > window.innerHeight) y = window.innerHeight - ch - 8;
    contextMenu.style.left = x + "px";
    contextMenu.style.top = y + "px";
    contextMenu.style.display = "flex";
    contextMenu.focus();
  }
  document.addEventListener("click", () => { contextMenu.style.display = "none"; });
  contextMenu.addEventListener("keydown", e => {
    if(e.key === "Escape") {
      contextMenu.style.display = "none";
      desktop.focus();
    }
  });
  contextMenu.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();
      const action = btn.dataset.action;
      contextMenu.style.display = "none";
      handleContextMenuAction(action);
    });
  });
  function handleContextMenuAction(action) {
    switch(action) {
      case "restart": restartSystem(); break;
      case "toggle-theme": toggleTheme(); break;
      case "new-note": openAppWindow("notes"); break;
      case "open-settings": openAppWindow("settings"); break;
    }
  }

  /* ----- Utilities: Restart & theme toggle ----- */
  let restartInProgress = false;
  function restartSystem() {
    if(restartInProgress) return;
    restartInProgress = true;
    restartOverlay.classList.add("show");
    setTimeout(() => location.reload(), 1100);
  }
  function toggleTheme() {
    if(currentTheme === "light") {
      currentTheme = "dark";
      document.body.classList.add("dark");
    } else {
      currentTheme = "light";
      document.body.classList.remove("dark");
    }
    saveUserPrefs();
    addNotification(`Theme changed to ${currentTheme}.`);
  }

  /* ----- Keyboard shortcuts ----- */
  window.addEventListener("keydown", e => {
    if((e.metaKey || e.ctrlKey) && !e.repeat) {
      switch(e.key.toLowerCase()) {
        case "t":
          e.preventDefault();
          toggleTheme();
          break;
        case "r":
          e.preventDefault();
          restartSystem();
          break;
        case "f":
          e.preventDefault();
          if(spotlightModal.style.display === "flex") closeSpotlight();
          else openSpotlight();
          break;
      }
    }
    if(e.key === "Escape") {
      if(spotlightModal.style.display === "flex") closeSpotlight();
    }
  });

  /* ----- Initialization ----- */
  function init() {
    loadUserPrefs();
    loadDesktopIconPositions();
    loadNotes();
    setupDock();
    setupDesktopIcons();
  }
  init();

})();

</script>

</body>
</html>
